name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install google-generativeai

      - name: AI Reviewer (Direct Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.AI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          import google.generativeai as genai
          import subprocess
          import sys

          def run():
              try:
                  genai.configure(api_key=os.environ['GEMINI_API_KEY'])
                  # Tentando usar o modelo Pro que e o mais estavel para essas tarefas
                  model = genai.GenerativeModel('gemini-1.5-pro')
                  
                  # Pega o diff do PR (compara base com head)
                  diff = subprocess.check_output(['git', 'diff', 'origin/${{ github.base_ref }}...HEAD']).decode('utf-8')
                  
                  if not diff:
                      print('No changes found.')
                      return

                  prompt = f'''Aja como um Engenheiro de Seguran√ßa S√™nior (DevSecOps). 
                  Analise o DIFF deste Pull Request em Portugu√™s buscando:
                  1. Vulnerabilidades OWASP Top 10 (especialmente SQL Injection e Insecure Deserialization).
                  2. Code Smells e melhorias de c√≥digo.
                  3. Melhores pr√°ticas de Java 25 e Spring Boot.

                  DIFF:
                  {diff}
                  
                  Responda de forma concisa em Portugu√™s diretamente no coment√°rio.
                  '''
                  
                  response = model.generate_content(prompt)
                  review_text = response.text
                  
                  # Salva o coment√°rio em um arquivo para o gh CLI
                  with open('review.md', 'w') as f:
                      f.write('### ü§ñ IA Code Review (Gemini)\n\n' + review_text)
                  
                  # Posta o coment√°rio no PR usando o gh CLI que ja vem no runner
                  subprocess.run(['gh', 'pr', 'comment', str(${{ github.event.pull_request.number }}), '--body-file', 'review.md'], check=True)
                  print('Review posted successfully.')
              except Exception as e:
                  print(f'Error during AI review: {e}')
                  sys.exit(1)

          run()
          "
